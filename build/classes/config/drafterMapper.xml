<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="drafterMapper">
	<select id="getReqList" parameterType="com.oopsw.model.VO.GetListVO" resultType="com.oopsw.model.VO.DocumentVO">
		select document_no documentNo, deadline, draft_date draftDate, completion_date completionDate, approved_document_no approvedDocumentNo, title, process_status processStatus, total_count totalCount
		from (
		    select d.*, row_number() over (order by draft_date DESC) as rn,
		    count(*) over() as total_count
		    from document d
		    where d.employee_id = #{employeeId} and process_status != '임시저장'
		    <if test="processStatus != null and processStatus != ''">
               and d.process_status = #{processStatus}
            </if>
		)
		where rn between (#{page} - 1) * 8 + 1 and #{page} * 8
	</select>
	<select id="setForm" parameterType="String" resultType="com.oopsw.model.VO.FormVO">
		select form_name formName, form_content formContent
		from document_form
		where form_usage = 'Y' and form_id = #{formId}
	</select>
	<select id="getDefaultLine" parameterType="com.oopsw.model.VO.GetDefaultLineVO" resultType="com.oopsw.model.VO.DefaultLineVO">
		select e2.employee_id employeeId, e2.name, e2.department, d.rank, d.line_order lineOrder
		from employee e1
		join default_approval_line d on d.form_id = #{formId}
		join employee e2 on e2.rank = d.rank
		where e1.employee_id = #{employeeId} and e2.department = e1.department
	</select>
	<insert id="addDoc" parameterType="com.oopsw.model.VO.DocumentVO">
		<selectKey keyProperty="documentNo" resultType="int" order="BEFORE">
			select document_no_seq.nextval from dual
		</selectKey>
		insert into document (document_no, employee_id, form_id, title, contents, draft_date, process_status, deadline)
		values (#{documentNo}, #{employeeId}, #{formId}, #{title}, #{contents}, sysdate, '진행중', #{deadline})
	</insert>
	<insert id="addApprovers" parameterType="com.oopsw.model.VO.ApprovalLineVO">
		<selectKey keyProperty="approvalLineNo" resultType="int" order="BEFORE">
			select approval_line_no_seq.nextval from dual
		</selectKey>
		insert into approval_line (approval_line_no, document_no, approver_id, line_order, approval_status)
		values (#{approvalLineNo}, #{documentNo}, #{approverId}, #{lineOrder}, #{approvalStatus})
	</insert>
	<insert id="sendFirstReqNoti" parameterType="int">
		insert into approval_request_noti (request_noti_no, approval_line_no, noti_in_date)
		values (request_noti_no_seq.nextval, #{firstApprovalLineNo}, sysdate)
	</insert>
	<insert id="saveTempDoc" parameterType="com.oopsw.model.VO.DocumentVO">
		<selectKey keyProperty="documentNo" resultType="int" order="BEFORE">
			select document_no_seq.nextval from dual
		</selectKey>
		insert into document (document_no, employee_id, form_id, title, contents, process_status, temporary_save_date, deadline)
		values (#{documentNo}, #{employeeId}, #{formId}, #{title}, #{contents}, '임시저장', sysdate, #{deadline})
	</insert>
	<select id="getTempList" parameterType="com.oopsw.model.VO.GetListVO" resultType="com.oopsw.model.VO.TempDocumentVO">
		select documentNo, formName, title, processStatus, temporarySaveDate, totalCount
		from (
	        select
		    d.document_no documentNo, df.form_name formName, d.title, d.process_status processStatus, d.temporary_save_date temporarySaveDate,
	        ROW_NUMBER() OVER (ORDER BY d.temporary_save_date DESC) AS rn,
	        COUNT(*) OVER() AS totalCount
		    from document d
	        join document_form df on d.form_id = df.form_id
			where d.employee_id = #{employeeId} and process_status = '임시저장'
		)
		where rn between (#{page} - 1) * 8 + 1 and #{page} * 8
	</select>
	<update id="submitTempDoc" parameterType="com.oopsw.model.VO.DocumentVO">
		update document set title = #{title}, contents=#{contents}, deadline = #{deadline}, draft_date = sysdate, process_status = '진행중'
		where document_no = #{documentNo}
	</update>
	<update id="editTempDoc" parameterType="com.oopsw.model.VO.DocumentVO">
		update document set title = #{title}, contents=#{contents}, deadline = #{deadline}, temporary_save_date = sysdate
		where document_no = #{documentNo}
	</update>
	<delete id="removeApprovers" parameterType="int">
		delete from approval_line where document_no = #{documentNo}
	</delete>
	<select id="getApprovalStatus" parameterType="int" resultType="com.oopsw.model.VO.ApprovalStatusVO">
		select distinct
	    al.approval_line_no approvalLineNo,
	    approver.employee_id approverId,
	    approver.name name,
	    approver.department department,
	    approver.rank rank,
	    al.line_order lineOrder,
	    al.approval_date approvalDate,
	    al.approval_status approvalStatus,
	    al.opinion,
	    arn.request_read_status requestReadStatus
		from approval_line al
		join employee approver on al.approver_id = approver.employee_id
		left join approval_request_noti arn on al.approval_line_no = arn.approval_line_no
		where al.document_no = #{documentNo}
		order by al.line_order
	</select>
	<select id="getApprovalProcessNoti" parameterType="com.oopsw.model.VO.GetListVO" resultType="com.oopsw.model.VO.AlarmVO" >
		select a.process_noti_no notiNO, a.document_no documentNo, d.title, d.approved_document_no approvedDocumentNo, process_status status, d.completion_date notiInDate, a.process_read_status readStatus
		from approval_process_noti a
		join document d on a.document_no = d.document_no
		where d.employee_id = #{employeeId}
		<if test="processStatus != null and processStatus != ''">
          and d.process_status = #{processStatus}
        </if>
	</select>
	<select id="getUnReadApprovalProcessNoti" parameterType="com.oopsw.model.VO.GetListVO" resultType="com.oopsw.model.VO.AlarmVO" >
		select a.process_noti_no notiNO, a.document_no documentNo, d.title, d.approved_document_no approvedDocumentNo, process_status status, d.completion_date notiInDate, a.process_read_status readStatus
		from approval_process_noti a
		join document d on a.document_no = d.document_no
		where d.employee_id = #{employeeId} and a.process_read_status is null
		<if test="processStatus != null and processStatus != ''">
          and d.process_status = #{processStatus}
        </if>
	</select>
</mapper>
